1) Требования
— Стриминг: инициализация сервиса
— В приложении создать сервис: from streaming_anomaly_service import AnomalyService; svc = AnomalyService("artifacts") — «аrtifacts» это путь к папке с model_if.pkl/meta.json.  
— Сервис готов принимать сообщения и вести состояние по каждому (group_id, sequence_id) до накопления min max_lag точек, необходимых для старта детекции.: pip install scikit-learn pandas numpy для обучения IsolationForest, сохранения/загрузки модели и детекции аномалий.  
— Python‑скрипты используют argparse для CLI, что позволяет задавать параметры обучения из консоли.  

2) Файлы проекта
— anomaly_model.py: логика признаков, конфиг ADConfig, обучение IsolationForest, сохранение/загрузка артефактов model_if.pkl/meta.json.  
— train_anomaly.py: CLI для обучения из структуры данных и записи артефактов в указанный каталог с помощью pickle.  
— streaming_anomaly_service.py: сервис со StreamingAnomalyDetector и AnomalyService, метод process_message(msg, K) для онлайн‑детекции аномалий.  

3) Подготовка данных
— convert_data.py читает структуру папок с физиологическими данными (hypoxia/regular -> group_id -> bpm/uterus -> CSV файлы), объединяет их в единый DataFrame с колонками: timestamp, group_id, sequence_id, bpm, uterus, target.  
— timestamp уже в секундах от эпохи после merge_physiological_data, дополнительного преобразования не требуется.  
— Значения group_id гарантируют раздельность пациентов в train/valid через GroupShuffleSplit при обучении.  

4) Обучение (CLI)
— Команда: python train_anomaly.py --input_csv /path/to/data_directory --out_dir artifacts --n_estimators 300 — обучит IsolationForest и валидирует по группам (group_id).  
— Параметр --input_csv ожидает путь к папке с данными (содержащей hypoxia/regular подпапки), а не к CSV файлу.  
— Дополнительные параметры: --n_estimators, --max_samples, --contamination, --max_features, --val_size, --random_state, --n_jobs — переопределяют значения из ADConfig, не изменяя код.  

5) Где сохраняется модель
— После успешного обучения в каталоге --out_dir появятся: model_if.pkl (IsolationForest) и meta.json (конфиг и список feature_cols), сохранённые через pickle и JSON‑дамп.  
— Эти артефакты используются инференс‑сервисом через pickle.load и чтение meta.json для консистентного порядка признаков на predict.  

6) Стриминг: инициализация сервиса
— В приложении создать сервис: from streaming_anomaly_service import AnomalyService; svc = AnomalyService("artifacts") — «artifacts» это путь к папке с model_if.pkl/meta.json.  
— Опционально можно передать external_forecast_fn для использования внешней функции прогнозирования вместо простого продления последних значений.  
— Сервис готов принимать сообщения и вести состояние по каждому (group_id, sequence_id) до накопления min max_lag точек, необходимых для старта детекции.  

7) Формат входящего сообщения
— msg = "timestamp,bpm,uterus,group_id,sequence_id" — строка из 5 значений, разделённых запятыми.  
— timestamp может быть числом секунд от эпохи или ISO‑строкой, приводится к секундам внутри сервиса.  
— Для ISO‑строк время переводится через pandas.to_datetime(...).value/1e9, что обеспечивает единый формат времени для расчёта лагов.  

8) Вызов онлайн‑детекции аномалий
— На каждое сообщение: out = svc.process_message(msg) — метод обновит буферы и вернёт результат при готовности.  
— Ответ в строковом формате: "ready:bool,detection:data,needed:int"; когда ready=true, detection содержит строку формата: timestamp,group_id,sequence_id,bpm,uterus,bpm_anomaly,uterus_anomaly,anomaly_score.  

9) Когда начинается детекция
— Для каждого ряда сервис накапливает минимум max_lag исторических точек, после чего переходит к регулярным обновлениям update_one+detect_anomaly при приходе новых сообщений.  
— До прогрева поле "needed" сообщает, сколько точек ещё требуется накопить для старта детекции по данному (group_id, sequence_id).  

10) Принцип детекции аномалий
— IsolationForest обучается только на тренировочных данных и определяет "нормальное" поведение.  
— Для каждой новой точки строятся признаки на основе истории (лаги и скользящие окна).  
— Модель возвращает bpm_anomaly и uterus_anomaly (0 для нормы, 1 для аномалии) и anomaly_score (чем меньше, тем более аномально).  

11) Смена версии модели
— Переобучить модель новой командой train_anomaly.py на свежих данных и сохранить в новый каталог, например artifacts_v2.  
— Запустить сервис с новым путём: AnomalyService("artifacts_v2") или переключить путь при деплое, обеспечив атомарную смену модели.

12) Пример использования
# svc = AnomalyService(model_dir="artifacts")
# msg = "1609459200,85.5,12.3,patient_1,session_1"
# out = svc.process_message(msg)
# # Парсинг ответа: "ready:true,detection:1609459200,patient_1,session_1,85.5,12.3,0,0,-0.123,needed:0"
# parts = out.split(',')
# if parts[0] == "ready:true":
#     detection_data = parts[1].split(':')[1] + ',' + ','.join(parts[2:])
#     values = detection_data.split(',')
#     print(f"BPM anomaly: {values[5]}, Uterus anomaly: {values[6]}")
#     print(f"Anomaly score: {values[7]}")